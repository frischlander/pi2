{% extends 'base.html' %}

{% block content %}
<div class="container-fluid p-4 mt-3">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #28a745;">
                <div class="icon">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_finalizadas }}</div>
                    <div class="label">Finalizadas</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #17a2b8;">
                <div class="icon">
                    <i class="bi bi-gear-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_em_andamento }}</div>
                    <div class="label">Em Andamento</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #e98604;">
                <div class="icon">
                    <i class="bi bi-question-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_aguardando }}</div>
                    <div class="label">Aguardando Parecer</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #dc3545;">
                <div class="icon">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_canceladas }}</div>
                    <div class="label">Canceladas</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-5 mt-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-center mb-0">LISTA DE ORDENS DE SERVIÇO</h3>
        <div>
            <div class="dropdown d-inline-block me-3">
                <button class="btn btn-outline-success dropdown-toggle" type="button" id="perPageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-list-ul me-1"></i> {{ per_page }} itens
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="perPageDropdown">
                    <li><a class="dropdown-item {% if per_page == 10 %}active{% endif %}" href="?per_page=10">10 itens</a></li>
                    <li><a class="dropdown-item {% if per_page == 25 %}active{% endif %}" href="?per_page=25">25 itens</a></li>
                    <li><a class="dropdown-item {% if per_page == 50 %}active{% endif %}" href="?per_page=50">50 itens</a></li>
                    <li><a class="dropdown-item {% if per_page == 100 %}active{% endif %}" href="?per_page=100">100 itens</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#filtroModal">
                <i class="bi bi-funnel"></i> Filtros
            </button>
            <a href="{% url 'gerar_pdf_lista' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success me-2" target="_blank" rel="noopener noreferrer">
                <i class="bi bi-file-pdf"></i> Gerar PDF
            </a>
            <a href="{% url 'add_ordem' %}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nova Ordem de Serviço
            </a>
        </div>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible d-flex align-items-center" role="alert">
            <div class="flex-grow-1">{{ message }}</div>
            <button type="button" class="btn-close ms-3" data-bs-dismiss="alert" aria-label="Close" style="background: none; border: none; font-size: 1.5rem; line-height: 1; padding: 0; opacity: 0.5; transition: opacity 0.2s;">
                <i class="bi bi-x"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Modal de Filtros -->
    <div class="modal fade" id="filtroModal" tabindex="-1" aria-labelledby="filtroModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filtroModalLabel">Filtros de Busca</h5>
                    <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <form method="get" id="filtroForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Processo</label>
                                    <input type="text" class="form-control" name="processo" value="{{ filtros.processo }}" placeholder="Digite o número do processo...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Nome do Solicitante</label>
                                    <input type="text" class="form-control" name="nome" value="{{ filtros.nome }}" placeholder="Digite o nome...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Tipo de Serviço</label>
                                    <select class="form-select" name="tipo">
                                        <option value="">Todos</option>
                                        <option value="atendimento_veterinario" {% if filtros.tipo == 'atendimento_veterinario' %}selected{% endif %}>Atendimento Veterinário</option>
                                        <option value="denuncia_maus_tratos" {% if filtros.tipo == 'denuncia_maus_tratos' %}selected{% endif %}>Denúncia de Maus Tratos</option>
                                        <option value="castracao" {% if filtros.tipo == 'castracao' %}selected{% endif %}>Castração</option>
                                        <option value="captura_grande_porte" {% if filtros.tipo == 'captura_grande_porte' %}selected{% endif %}>Captura de Animais de Grande Porte</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Endereço</label>
                                    <input type="text" class="form-control" name="endereco" value="{{ filtros.endereco }}" placeholder="Digite o endereço...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status">
                                        <option value="">Todos</option>
                                        <option value="nao_iniciada" {% if filtros.status == 'nao_iniciada' %}selected{% endif %}>Não Iniciada</option>
                                        <option value="em_andamento" {% if filtros.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                        <option value="aguardando_parecer" {% if filtros.status == 'aguardando_parecer' %}selected{% endif %}>Aguardando Parecer</option>
                                        <option value="finalizada" {% if filtros.status == 'finalizada' %}selected{% endif %}>Finalizada</option>
                                        <option value="cancelada" {% if filtros.status == 'cancelada' %}selected{% endif %}>Cancelada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Data de Criação</label>
                                    <input type="date" class="form-control" name="data_criacao" value="{{ filtros.data_criacao }}">
                                    <small class="text-muted">Filtrar por data de criação da ordem</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{% url 'caaordserv' %}" class="btn btn-secondary">Limpar Filtros</a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-funnel"></i> Aplicar Filtros
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col" class="text-center">Processo</th>
            <th scope="col" class="text-center">Nome</th>
            <th scope="col" class="text-center">Tipo</th>
            <th scope="col" class="text-center">Endereço</th>
            <th scope="col" class="text-center">Status</th>
            <th scope="col" class="text-center" style="min-width: 200px;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for ordem in ordens %}
          <tr>
            <th scope="row" class="text-center">{{ ordem.get_processo_display }}</th>
            <td class="text-center">{{ ordem.nome_solicitante }}</td>
            <td class="text-center">{{ ordem.get_tipo_display }}</td>
            <td class="text-center">{{ ordem.endereco }}</td>
            <td class="text-center">
                {% if ordem.status == 'finalizada' %}
                    <span class="badge badge-success rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Finalizada</span>
                {% elif ordem.status == 'em_andamento' %}
                    <span class="badge rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px; background-color: #17a2b8; color: white;">Em Andamento</span>
                {% elif ordem.status == 'aguardando_parecer' %}
                    <span class="badge badge-warning rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Aguardando Parecer</span>
                {% elif ordem.status == 'cancelada' %}
                    <span class="badge badge-danger rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Cancelada</span>
                {% else %}
                    <span class="badge badge-secondary rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">{{ ordem.get_status_display }}</span>
                {% endif %}
            </td>
            <td class="text-center">
                <a href="{% url 'view_ordem' ordem.processo %}{% if request.GET.page %}?page={{ request.GET.page }}{% endif %}" class="btn btn-sm btn-link text-info fs-5" title="Visualizar">
                    <i class="bi bi-eye-fill"></i>
                </a>
                <a href="{% url 'edit_ordem' ordem.processo %}{% if request.GET.page %}?page={{ request.GET.page }}{% endif %}" class="btn btn-sm btn-link text-primary fs-5" title="Editar">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                <button type="button" class="btn btn-sm btn-link text-danger fs-5" data-bs-toggle="modal" data-bs-target="#deleteModal{{ ordem.id }}" title="Excluir">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
            </td>
          </tr>

          <!-- Modal de Confirmação de Exclusão -->
          <div class="modal fade" id="deleteModal{{ ordem.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ ordem.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel{{ ordem.id }}">Confirmar Exclusão</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Tem certeza que deseja excluir a ordem de serviço <strong>{{ ordem.processo }}</strong>?</p>
                  <p class="text-danger">Esta ação não poderá ser desfeita.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <a href="{% url 'delete_ordem' ordem.processo %}" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Confirmar Exclusão
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">Nenhuma ordem de serviço encontrada.</td>
          </tr>
          {% endfor %}
        </tbody>
    </table>

    {% if is_paginated %}
    <nav aria-label="Navegação de páginas" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1" aria-label="Primeira">
              <span aria-hidden="true">&laquo;&laquo;</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Próxima">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Última">
              <span aria-hidden="true">&raquo;&raquo;</span>
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
</div>

<style>
.btn-sm {
    margin-right: 8px;
    padding: 0.25rem 0.5rem;
}

.btn-sm:last-child {
    margin-right: 0;
}

.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 1.5rem;
}

.modal-header .btn-close {
    background: none;
    font-size: 1.5rem;
    padding: 0;
    margin: 0;
    opacity: 1;
    width: auto;
    height: auto;
}

.modal-header .btn-close i {
    color: #495057;
}

.modal-header .btn-close:hover i {
    color: #000;
}

.modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.modal-title {
    color: #00a652;
    font-weight: 600;
}

/* Estilos da paginação */
.pagination .page-link {
    color: #00a652;
    border-color: #00a652;
}

.pagination .page-item.active .page-link {
    background-color: #00a652;
    border-color: #00a652;
    color: white;
}

.pagination .page-link:hover {
    background-color: #00a652;
    border-color: #00a652;
    color: white;
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    border-color: #dee2e6;
    background-color: #fff;
}

/* Estilos dos filtros */
.form-group {
    margin-bottom: 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: #00a652;
    box-shadow: 0 0 0 0.2rem rgba(0, 166, 82, 0.25);
}

.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
}

.modal-lg {
    max-width: 800px;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
}

.btn-success {
    background-color: #00a652;
    border-color: #00a652;
}

.btn-success:hover {
    background-color: #008f45;
    border-color: #008f45;
}

/* Indicador de filtros ativos */
.btn-success[data-bs-toggle="modal"] {
    position: relative;
}

.btn-success[data-bs-toggle="modal"]::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 8px;
    height: 8px;
    background-color: #ffc107;
    border-radius: 50%;
    display: none;
}

.btn-success[data-bs-toggle="modal"].has-filters::after {
    display: block;
}

/* Ajustes para os campos do modal */
.form-control, .form-select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.form-select {
    background-color: #fff;
}

/* Estilos do dropdown de itens por página */
.dropdown-menu {
    border: none;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border-radius: 0.5rem;
    padding: 0.5rem 0;
}

.dropdown-item {
    padding: 0.5rem 1.5rem;
    color: #495057;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #00a652;
}

.dropdown-item.active {
    background-color: #00a652;
    color: white;
}

.btn-outline-success {
    color: #00a652;
    border-color: #00a652;
    padding: 0.375rem 1rem;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
}

.btn-outline-success:hover {
    background-color: #00a652;
    color: white;
    border-color: #00a652;
}

.btn-outline-success:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 166, 82, 0.25);
}

/* Ajuste do espaçamento dos botões de ação */
.btn-sm {
    margin-right: 8px;
    padding: 0.25rem 0.5rem;
}

.btn-sm:last-child {
    margin-right: 0;
}

/* Ajuste da largura da coluna de ações */
.table th:last-child,
.table td:last-child {
    min-width: 200px;
    white-space: nowrap;
}

/* Estilos para os alerts */
.alert {
    transition: opacity 0.3s ease-in-out;
    opacity: 1;
    position: relative;
    padding-right: 3rem;
}

.alert .btn-close {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
}

.alert .btn-close:hover {
    opacity: 1;
}

.alert.fade {
    opacity: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fecha automaticamente os alerts após 3 segundos
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            alert.remove();
        }, 3000);
    });

    // Inicializa todos os modais
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        new bootstrap.Modal(modal, {
            keyboard: false,
            backdrop: 'static'
        });
    });

    // Verifica se há filtros ativos
    const filtroBtn = document.querySelector('[data-bs-toggle="modal"]');
    const filtros = JSON.parse('{{ filtros|safe }}');
    const hasFilters = Object.values(filtros).some(value => value !== '');
    if (hasFilters) {
        filtroBtn.classList.add('has-filters');
    }

    // Mantém os parâmetros de paginação ao aplicar filtros
    const filtroForm = document.getElementById('filtroForm');
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    
    if (page) {
        const pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'page';
        pageInput.value = page;
        filtroForm.appendChild(pageInput);
    }
});
</script>
{% endblock content %}