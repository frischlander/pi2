<script>
  document.addEventListener('DOMContentLoaded', function() {
    if ('speechSynthesis' in window) {
      const fabButton = document.getElementById('leitor-texto-fab');
      fabButton.style.display = 'block';

      let chunksParaLer = [];
      let chunkAtual = 0;

      // Prepara a lista de textos UMA ÚNICA VEZ
      function prepararTexto() {
          const areaDeLeitura = document.querySelector('body');
          if (!areaDeLeitura) return;
          const elementos = areaDeLeitura.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, th, td, a, label');
          chunksParaLer = Array.from(elementos).map(el => el.textContent.trim()).filter(text => text);
          chunkAtual = 0;
      }
      
      prepararTexto();

      // Função principal que é chamada ao clicar
      function gerenciarLeitura() {
        // Se o navegador estiver falando, o comando é para parar.
        if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          // O próprio evento 'onend' que será disparado vai resetar o botão.
          return;
        }

        // Se não estiver falando, o comando é para ler o próximo trecho.
        if (chunkAtual >= chunksParaLer.length) {
            chunkAtual = 0; // Reinicia se chegou ao fim da lista
        }
        
        const textoDoChunk = chunksParaLer[chunkAtual];

        if (textoDoChunk) {
            const utterance = new SpeechSynthesisUtterance(textoDoChunk);
            utterance.rate = 0.85; 
            utterance.lang = 'pt-BR';

            // Configura o que acontece quando a fala começa
            utterance.onstart = function() {
              fabButton.innerHTML = '<i class="fas fa-stop"></i>';
              fabButton.classList.remove('btn-primary');
              fabButton.classList.add('btn-danger');
              fabButton.title = 'Parar leitura (Alt + L)';
            };
            
            // Configura o que acontece quando a fala termina (seja por fim ou por cancelamento)
            utterance.onend = function() {
              fabButton.innerHTML = '<i class="fas fa-play"></i>';
              fabButton.classList.remove('btn-danger');
              fabButton.classList.add('btn-primary');
              fabButton.title = 'Ler próxima parte (Alt + L)';
            };
            
            window.speechSynthesis.speak(utterance);
            // Avança para o próximo trecho, garantindo que não se repetirá
            chunkAtual++;
        }
      }

      // Conecta a função ao botão e ao atalho
      fabButton.addEventListener('click', gerenciarLeitura);
      document.addEventListener('keydown', function(event) {
        if (event.altKey && event.key === 'l') {
          event.preventDefault();
          gerenciarLeitura();
        }
      });

      // Limpa a fala se o usuário sair da página
      window.addEventListener('beforeunload', () => {
        window.speechSynthesis.cancel();
      });

    } else {
      console.log('Seu navegador não suporta a funcionalidade de leitura de texto.');
    }
  });
</script>